<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>bigValley</title>

    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
    <script type="application/javascript">  

        var epoch;   // define a container variable to hold the data
        var yearStats;
        var year = 0;
        var maxyear;
        var epochNum = 0;
        var maxEpochs = 550; // number of epochs to run before quitting (should generate this from file, but how?)
        var successYears = 500; // ceiling for how many years in an epoch
        var epochFinish;
        
        function getData(epochNumberString) {
            d3.csv("plotData/plotDF-" + epochNumberString + ".csv", function(d) {
                // assign the data to the epoch variable
                epoch = d;

                // assign value to maxyear
                maxyear = d3.max(epoch.map(d => d.year).map(Number));
                // print epoch number
                document.querySelector('.title .epochNum').innerHTML = epochNum;
                
                // load data for making statPlots
                //loadStatPlots();
                
            });
            
            d3.csv("plotData/paramStats-" + epochNumberString +".csv", function(d) {
                // assign the data to the epoch variable
                yearStats = d;
                //
                var yearSVG = d3.select("#countYearPlot");
                yearSVG.selectAll("circle").remove();
                var yearSVG = d3.select("#critterYearPlot");
                yearSVG.selectAll("circle").remove();
                
                // assign value to maxyear
                //maxyear = d3.max(epoch.map(d => d.year).map(Number));
                // print epoch number
                //document.querySelector('.title .epochNum').innerHTML = epochNum;
                
                // load data for making statPlots
                //loadStatPlots();
                
            });

        } 
        
        
        function startEpoch() {
            // increment epoch
            epochNum++
            
            // load the data and run the world
            getData(epochNum.toString())
            running = setInterval(draw,50) // this is how many ms you wait between years

            
        }
        
        
        // THIS IS WHAT DRAWS THE WORLD EACH YEAR
        function draw() {
            // increment year
            year++
            document.querySelector('.title .titleYear').innerHTML = year;
            //document.querySelector('.title .epochFinish').innerHTML = epochFinish;
            
            // set up SVG
            var targetSVG = d3.select("#BVplot");

            var centerX = 500;
            var centerY = 350;
            
            // clear previous year output
            targetSVG.selectAll("circle").remove();
            
            // draw this year
            var circle = targetSVG.selectAll("circle")
                    .data(epoch.filter(function(d) { return d.year == year }))
                .enter().append("circle")
                    .attr ("cx",function(d) { return (d.lat*10) + centerX; })
                    .attr ("cy",function(d) { return (d.long*10) + centerY;})
                    .attr ("r",function(d) { return d.energy*0.03; })
                    .attr("fill",function(d) { 
                            if (d.name == "grass") {
                                return "green";
                            } else if (d.name == "wolf") {
                                return "purple";
                            } else if (d.name == "rabbit") {
                                return "blue";
                            } else {
                                return "gray";
                            }
                        });
            
            // plot stats for this year
            if (year < maxyear) {
                //document.querySelector('.epochStats .statsFile').innerHTML = "plotData/paramStats-" + epochNum.toString() +".csv";
                document.querySelector('.epochStats .wolfEn').innerHTML = yearStats[year]['wolfEn'];
                document.querySelector('.epochStats .wolfRe').innerHTML = yearStats[year]['wolfRe'];
                document.querySelector('.epochStats .rabbitEn').innerHTML = yearStats[year]['rabbitEn'];
                document.querySelector('.epochStats .rabbitRe').innerHTML = yearStats[year]['rabbitRe'];
                document.querySelector('.epochStats .wolfNum').innerHTML = yearStats[year]['wolfNum'];
                document.querySelector('.epochStats .rabbitNum').innerHTML = yearStats[year]['rabbitNum'];
                document.querySelector('.epochStats .grassNum').innerHTML = yearStats[year]['grassNum'];
                //document.querySelector('.epochStats .debrisNum').innerHTML = yearStats[year]['debrisNum'];
                //
                var yearSVG = d3.select("#countYearPlot");
            
                yearSVG.append("circle")
                    .attr ("cx",year)
                    .attr ("cy",Math.max((200-yearStats[year]['wolfNum']), 3))
                    .attr ("r",3)
                    .attr ("stroke-width",0)
                    .attr ("fill","purple");
                
                yearSVG.append("circle")
                    .attr ("cx",year)
                    .attr ("stroke-width",0)
                    .attr ("cy",Math.max((200-yearStats[year]['rabbitNum']), 2))
                    .attr ("r",3)
                    .attr ("fill","blue");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max((200-yearStats[year]['grassNum']), 1))
                        .attr ("r",3)
                        .attr ("fill","green");

                //
                var yearSVG = d3.select("#critterYearPlot");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['wolfEn']/3), 4)
                        .attr ("fill","purple");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['wolfRe']/3),3)
                        .attr ("r",3)
                        .attr ("fill","#9159B5");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['rabbitEn']/3),2)
                        .attr ("r",3)
                        .attr ("fill","blue");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['rabbitRe']/3),1)
                        .attr ("r",3)
                        .attr ("fill","#4569ED");
            }

            //
            //stop running if reached max years
            if(year > maxyear) {
                // stop running
                clearInterval(running);
                // reset year counter
                year = 0;
                
                // print 'EXTINCTION' or 'SUCCESS'
                if (epochFinish == successYears) {
                    document.querySelector('.title .titleYear').innerHTML = '*SUCCESS!*';
                    // if there are more epoch, start the next one
                    if (epochNum < maxEpochs) {
                        setTimeout(startEpoch, 1750); //pause for a second
                        targetSVG.append("circle")   //draw a black circle
                            .attr("cx",centerX)
                            .attr("cy",centerY)
                            .attr("r",200)
                            .attr("fill", 'green');
                        
                        loadStatPlots();
                    }
                } else{
                    document.querySelector('.title .titleYear').innerHTML = 'EXTINCTION!';
                    // if there are more epoch, start the next one
                    if (epochNum < maxEpochs) {
                        setTimeout(startEpoch, 500); //pause for a second
                        targetSVG.append("circle")   //draw a black circle
                            .attr("cx",centerX)
                            .attr("cy",centerY)
                            .attr("r",200)
                            .attr("fill", 'black');
                        
                        loadStatPlots();
                    }
                }
    

            }
            
        }
        
        function loadStatPlots() {
            // load epoch stats for display
            d3.csv("plotData/epochStats.csv", function(d) {
                // define the max year that this epoch achieves.
                epochFinish = d[epochNum]['firstExt'];
                
                // CAN PROBABLY DELETE THIS PART... (for showing the numbers in object as text)
                //document.querySelector('.epochStats .summary').innerHTML = JSON.stringify(d[epochNum], null, 2);
                
                // plot epoch Stats
                
                var epochSVG = d3.select("#countStatsPlot");

                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['wolfNum']*2)
                        .attr ("fill","purple");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['rabbitNum']*2)
                        .attr ("r",3)
                        .attr ("fill","blue");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['grassNum']*2)
                        .attr ("r",3)
                        .attr ("fill","green");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['debrisNum']*2)
                        .attr ("r",3)
                        .attr ("fill","gray");
                
                //
                var epochSVG = d3.select("#critterStatsPlot");

                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['wolfEn']/4)
                        .attr ("fill","purple");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['wolfRe']/4)
                        .attr ("r",3)
                        .attr ("fill","#9159B5");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['rabbitEn']/4)
                        .attr ("r",3)
                        .attr ("fill","blue");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['rabbitRe']/4)
                        .attr ("r",3)
                        .attr ("fill","#4569ED");
                
                //
                var epochSVG = d3.select("#firstExtStatsPlot");

                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['firstExt']/2.525)
                        .attr ("fill", "black");
                        /*.attr ("fill",function(d) {
                                if (d[epochNum]['firstExt'] == successYears) {
                                    return 'red';
                                } else {
                                   return 'black'; 
                                }
                            } ); */ //for some reason this breaks the pause at epoch finish 
            
            });
        }
        
        function skipEpochs(num) {
            clearInterval(running);
                // reset year counter
            year = 0;
            epochNum += num;
            startEpoch();
        }
        
        
    </script>
    
    <style>
        line {
            stroke-width: 2;
        }
        
        circle {
            stroke: #ccc;
        }
        
        .button {
        background-color: #000000;
        color: #FFFFFF;
        padding: 10px;
        border-radius: 10px;
        -moz-border-radius: 10px;
        -webkit-border-radius: 10px;
        margin:10px
        }

        .big-btn {
            width: 90px;
            height: 40px;
        }
        
    </style>
    
    
</head>
<!--<body onload="getData('plotDF-3')">-->
<body>
    <h1 style="padding-left: 375px;">Big Valley</h1>

<!--    the button to run the world. -->
<!--    <button onclick="startEpoch()">start the universe.</button><br>-->
    <div onclick="startEpoch()" class="button big-btn">start the universe.</div>
<!--    other buttons -->
    <button onclick="skipEpochs(1)">skip 1 epoch</button>
    <button onclick="skipEpochs(10)">skip 10 epochs</button><p></p>
    <p>Read the background and methodology in the <a href="https://github.com/seth127/seth127.github.io/blob/master/README.md" target="_blank">README</a>.
    Scroll to down to see stats on each year and each epoch.</p>
<!--    <button onclick="running = setInterval(draw,200)">run the world</button>-->
<!--    <button onclick="clearInterval(running)">stop the world</button>-->
    
<!--  THE BIG PLOT   -->
    <h2 class="title" style="padding-left: 375px;">Year <span class='titleYear'></span> in epoch <span class='epochNum'></span></h2>
<!--  of <span class='epochFinish'></span>   -->
    <svg id="BVplot" width="1000" height="800"></svg>
    <br>
    
<!--  plotting year stats  -->
    <h3>Year Stats throughout this Epoch:</h3>
    <svg id="critterYearPlot" width="500" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
    <svg id="countYearPlot" width="500" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
    <div><span style="padding-left: 125px;">Critter Avg Energy and Repro</span><span style="padding-left: 375px;">Critter Counts</span></div>
    <p></p><p></p>

    <!--    <div class="epochStats">THIS EPIC: <span class='summary'></span></div>-->
    <div class="epochStats">
<!--        <span class='statsFile'></span><br>-->
        Avg Wolf Energy: <span class='wolfEn'></span> // Avg Wolf Repro: <span class='wolfRe'></span> //// 
        Avg Rabbit Energy: <span class='rabbitEn'></span> // Avg Rabbit Repro: <span class='rabbitRe'></span>
        <br><br>
        Critter Counts:
        <span class='wolfNum'></span> Wolves // <span class='rabbitNum'></span> Rabbits // 
        <span class='grassNum'></span> Plants
    </div>
    
    <!--    the epochStats plots -->
    <h3>Epoch Stats: </h3>
    <svg id="critterStatsPlot" width="300" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
    <svg id="countStatsPlot" width="300" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
    <svg id="firstExtStatsPlot" width="300" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
    
    <div><span style="padding-left: 65px;">Critter Energy and Repro</span><span style="padding-left: 165px;">Critter Starting Counts</span><span style="padding-left: 175px;">First Extinction</span></div>
    <p></p><p></p>
    
</body>
</html>