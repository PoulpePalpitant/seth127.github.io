<!doctype html>
<html>
<head>
    <meta charset="UTF-8">
    <title>bigValley</title>

<!--    <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>-->
    <script src="d3/d3.min.js" charset="utf-8"></script>
    
    <script type="application/javascript">  

        var epoch;   // define a container variable to hold the data
        var yearStats;
        var year = 0;
        var maxyear;
        var epochNum = 0;
        var idList;
        //var modelChoice;
        
        var maxEpochs = 50; // max number of epochs before the program quits (generated from checkRadio())
        
        var successYears = 500; // ceiling for how many years in an epoch
        var epochFinish; // the 'firstExt' value for this epoch

        function onlyUnique(value, index, self) { 
            return self.indexOf(value) === index;
        }
    
        
        function getData(epochNumberString) {
            //d3.csv("plotData" + modelChoice + "/plotDF-" + epochNumberString + ".csv", function(d) {
            d3.csv("plotDataCont/plotDF-0.csv", function(d) {
                // assign the data to the epoch variable
                epoch = d;

                // assign value to maxyear
                maxyear = d3.max(epoch.map(d => d.year).map(Number));
                console.log("max year " + maxyear.toString())
                // print epoch number
                document.querySelector('.title .epochNum').innerHTML = epochNum;
                
                // load data for making statPlots
                //loadStatPlots();
                
            });
            
            d3.csv("plotDataCont/paramStats-0.csv", function(d) {
                // assign the data to the epoch variable
                yearStats = d;
                //
                var yearSVG = d3.select("#countYearPlot");
                yearSVG.selectAll("circle").remove();
                var yearSVG = d3.select("#critterYearPlot");
                yearSVG.selectAll("circle").remove();
                
                // get idList 
                allNames = yearStats.map(d => d.name).map(String);
                rabs = allNames.filter(function(name) {return name.includes('rabbit');});
                ids = rabs.map(function(rab) {return rab.split('rabbit')[0];});
                idList = ids.filter(onlyUnique);
            });
            
        } 
        
        
        function startEpoch() {
            // increment epoch
            epochNum++
            
            if (epochNum <= maxEpochs) {
                console.log(maxEpochs)
                // load the data and run the world
                getData(epochNum.toString())
                // check for length of data returned from getData? (or do it _in_ getData?)
                running = setInterval(draw,150) // this is how many ms you wait between years
            } else {
                document.querySelector('.title .titleYear').innerHTML = 'All done.';
            }
            
        }
        
        
        // THIS IS WHAT DRAWS THE WORLD EACH YEAR
        function draw() {
            // increment year
            year++
            document.querySelector('.title .titleYear').innerHTML = year;
            //document.querySelector('.title .epochFinish').innerHTML = epochFinish;
            
            // set up SVG
            var targetSVG = d3.select("#BVplot");

            var centerX = 500;
            var centerY = 450;
            
            // clear previous year output
            targetSVG.selectAll("circle").remove();
            
            // draw this year 
            var circle = targetSVG.selectAll("circle")
                    .data(epoch.filter(function(d) { return d.year == year ;}))
                .enter().append("circle")
                    .attr ("cx",function(d) { return (d.lat*10) + centerX; })
                    .attr ("cy",function(d) { return (d.long*10) + centerY;})
                    .attr ("r",function(d) { return Math.max(d.energy*0.02, 0); })
                    .attr("fill",function(d) { 
                            if (d.name.includes("grass")) {
                                return "green";
                            } else if (d.name.includes("wolf")) {
                                return "purple";
                            } else if (d.name.includes("rabbit")) {
                                return "blue";
                            } else if (d.name.includes("debris")) {
                                return "gray";
                            } else {
                                return "black";
                            }
                        })
                    .attr("stroke",function(d) { 
                            if (d.name.includes(idList[0])) {
                                return "black";
                            } else if (d.name.includes(idList[1])) {
                                return "red";
                            } else if (d.name.includes(idList[2])) {
                                return "yellow";
                            } else {
                                return "#ccc";
                            }
                        });

            
            // plot stats for this year
            if (year < maxyear) {
                //document.querySelector('.epochStats .statsFile').innerHTML = "plotData" + modelChoice + "/paramStats-" + epochNum.toString() +".csv";
                /*
                document.querySelector('.epochStats .wolfEn').innerHTML = yearStats[year]['wolfEn'];
                document.querySelector('.epochStats .wolfRe').innerHTML = yearStats[year]['wolfRe'];
                document.querySelector('.epochStats .rabbitEn').innerHTML = yearStats[year]['rabbitEn'];
                document.querySelector('.epochStats .rabbitRe').innerHTML = yearStats[year]['rabbitRe'];
                document.querySelector('.epochStats .wolfNum').innerHTML = yearStats[year]['wolfNum'];
                document.querySelector('.epochStats .rabbitNum').innerHTML = yearStats[year]['rabbitNum'];
                document.querySelector('.epochStats .grassNum').innerHTML = yearStats[year]['grassNum'];
                */
                //document.querySelector('.epochStats .debrisNum').innerHTML = yearStats[year]['debrisNum'];
                //
                var yearSVG = d3.select("#countYearPlot");
                //yearSVG.selectAll("circle").remove();
                
                var circle = yearSVG.selectAll("circle")
                        .data(yearStats.filter(function(d) { return d.year == year ;}), function(d){return d;})
                    .enter().append("circle")
                        .attr ("cx", year)
                        //.attr ("cy",function(d) { return (d.long*10) + centerY;})
                        .attr ("cy",function(d) { return Math.max((199 - d.value), 2);})
                        .attr ("r",3)
                        .attr ("stroke-width",0.5)
                        .attr("fill",function(d) { 
                                if (d.name.includes("grass")) {
                                    return "green";
                                } else if (d.name.includes("wolf")) {
                                    return "purple";
                                } else if (d.name.includes("rabbit")) {
                                    return "blue";
                                } else if (d.name.includes("debris")) {
                                    return "gray";
                                } else {
                                    return "black";
                                }
                            })
                        .attr("stroke",function(d) { 
                                if (d.name.includes(idList[0])) {
                                    return "black";
                                } else if (d.name.includes(idList[1])) {
                                    return "red";
                                } else if (d.name.includes(idList[2])) {
                                    return "yellow";
                                } else {
                                    return "#ccc";
                                }
                            });
                
                
                /*
                yearSVG.append("circle")
                    .attr ("cx",year)
                    .attr ("cy",Math.max((200-yearStats[year]['wolfNum']), 3))
                    .attr ("r",3)
                    .attr ("stroke-width",0)
                    .attr ("fill","purple");
                
                yearSVG.append("circle")
                    .attr ("cx",year)
                    .attr ("stroke-width",0)
                    .attr ("cy",Math.max((200-yearStats[year]['rabbitNum']), 2))
                    .attr ("r",3)
                    .attr ("fill","blue");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max((200-yearStats[year]['grassNum']), 1))
                        .attr ("r",3)
                        .attr ("fill","green");
                
                //
                var yearSVG = d3.select("#critterYearPlot");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['wolfEn']/3), 4)
                        .attr ("fill","purple");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['wolfRe']/3),3)
                        .attr ("r",3)
                        .attr ("fill","#9159B5");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['rabbitEn']/3),2)
                        .attr ("r",3)
                        .attr ("fill","blue");

                yearSVG.append("circle")
                        .attr ("cx",year)
                        .attr ("stroke-width",0)
                        .attr ("cy",Math.max(200-yearStats[year]['rabbitRe']/3),1)
                        .attr ("r",3)
                        .attr ("fill","#4569ED");
                */
            }

            //
            //stop running if reached max years
            if(year > maxyear) {
                // stop running
                clearInterval(running);
                // reset year counter
                year = 0;
                
                // print 'EXTINCTION' or 'SUCCESS'
                if (epochFinish == successYears) {
                    document.querySelector('.title .titleYear').innerHTML = '*SUCCESS!*';
                    //
                    targetSVG.append("circle")   //draw a green circle
                        .attr("cx",centerX)
                        .attr("cy",centerY)
                        .attr("r",200)
                        .attr("fill", 'green');
                    //
                    loadStatPlots(); // plot the results of this epoch
                    setTimeout(startEpoch, 1750); //pause for a second

                } else {
                    document.querySelector('.title .titleYear').innerHTML = 'EXTINCTION!';
                    //
                    targetSVG.append("circle")   //draw a black circle
                        .attr("cx",centerX)
                        .attr("cy",centerY)
                        .attr("r",200)
                        .attr("fill", 'black');
                    //
                    loadStatPlots(); // plot the results of this epoch
                    setTimeout(startEpoch, 500); //pause for a half a second, then start over

                }
    

            }
            
        }
        
        function loadStatPlots() {
            // load epoch stats for display
            //d3.csv("plotData" + modelChoice + "/epochStats.csv", function(d) {
            d3.csv("plotData/epochStats.csv", function(d) { // ##############THIS IS THE WRONG DATA? ####
                // define the max year that this epoch achieves.
                epochFinish = d[epochNum]['firstExt'];
                
                //maxEpochs = d.length;
                
                // CAN PROBABLY DELETE THIS PART... (for showing the numbers in object as text)
                //document.querySelector('.epochStats .summary').innerHTML = JSON.stringify(d[epochNum], null, 2);
                
                // plot epoch Stats
                
                var epochSVG = d3.select("#countStatsPlot");

                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['wolfNum']*2)
                        .attr ("fill","purple");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['rabbitNum']*2)
                        .attr ("r",3)
                        .attr ("fill","blue");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['grassNum']*2)
                        .attr ("r",3)
                        .attr ("fill","green");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['debrisNum']*2)
                        .attr ("r",3)
                        .attr ("fill","gray");

                //
                var epochSVG = d3.select("#critterStatsPlot");

                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['wolfEn']/4)
                        .attr ("fill","purple");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['wolfRe']/4)
                        .attr ("r",3)
                        .attr ("fill","#9159B5");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['rabbitEn']/4)
                        .attr ("r",3)
                        .attr ("fill","blue");
                
                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['rabbitRe']/4)
                        .attr ("r",3)
                        .attr ("fill","#4569ED");
                
                //
                var epochSVG = d3.select("#firstExtStatsPlot");

                epochSVG.append("circle")
                        .attr ("cx",epochNum)
                        .attr ("r",3)
                        .attr ("stroke-width",0)
                        .attr ("cy",200-d[epochNum]['firstExt']/2.525)
                        .attr ("fill", "black");
                        /*.attr ("fill",function(d) {
                                if (d[epochNum]['firstExt'] == successYears) {
                                    return 'red';
                                } else {
                                   return 'black'; 
                                }
                            } ); */ //for some reason this breaks the pause at epoch finish 
            
            });
        }
        
        function skipEpochs(num) {
            clearInterval(running);
                // reset year counter
            year = 0;
            epochNum += num;
            startEpoch();
        }
        
        function checkRadio() {
            for (i = 0; i < 2; i++) {
                if ( document.chooseModel.model[i].checked ) {
                    modelChoice = document.chooseModel.model[i].value;
                    break;
                }
            }
            console.log(modelChoice);
            
            // set initial value for maxEpochs I DON'T UNDERSTAND WHY THIS DOESN'T WORK
            d3.csv("plotData" + modelChoice + "/epochStats.csv", function(d) {
                maxEpochs = d.length;
            });
        }
        
        
    </script>
    
    <style>
        line {
            stroke-width: 2;
        }
        
        circle {
            stroke-width: 1.5;
/*            stroke: #ccc;*/
        }

        
        .button {
        background-color: #000000;
        color: #FFFFFF;
        padding: 10px;
        border-radius: 10px;
        -moz-border-radius: 10px;
        -webkit-border-radius: 10px;
        margin:10px
        white-space: wrap;
        }

        .big-btn {
            width: 90px;
            height: 40px;
        }
        
        *{font-family:"Trebuchet MS";}
        
    </style>
    
    
</head>
<!--<body onload="getData('plotDF-3')">-->
<body>
    <h1 style="padding-left: 375px;">Big Valley</h1>

<!--    the button to run the world. -->
<!--    <button onclick="startEpoch()">start the universe.</button><br> -->
<!--    <div onclick="checkRadio();setTimeout(startEpoch,200);" class="button big-btn">start the universe.</div>-->
    <div onclick="setTimeout(startEpoch,200);" class="button big-btn">start the universe.</div>
<!--    other buttons -->
    <button onclick="skipEpochs(1)">skip 1 epoch</button>
    <button onclick="skipEpochs(10)">skip 10 epochs</button>
<!--    <button onclick="running = setInterval(draw,200)">run the world</button>-->
    <button onclick="clearInterval(running)">pause the world</button>
    <p></p>
    <p>Read the background and methodology in the <a href="https://github.com/seth127/seth127.github.io/blob/master/bigValley/README.md" target="_blank">README</a>.
    Scroll to down to see stats on each year and each epoch.</p>
    <p></p>
<!--  PICK THE MODEL  -->
    <span><strong>choose modeling approach:</strong></span>
    <form name="chooseModel" action="">
      <input type="radio" name="model" value="RF" checked="checked"> Random Forest
      <input type="radio" name="model" value="LM"> Linear Response Surface<br>
    </form>
    
<!--  THE BIG PLOT   -->
    <h2 class="title" style="padding-left: 375px;">Year <span class='titleYear'></span> in epoch <span class='epochNum'></span></h2>
<!--  of <span class='epochFinish'></span>   -->
    <div style="white-space: nowrap;">
        <svg id="BVplot" width="1000" height="900"></svg>
        <img src="bv-legend.jpg" height=100 style="padding-bottom: 700px; display: inline-block;">
    </div>
    <br>
    
<!--  plotting year stats  -->
    <h3>Year Stats throughout this Epoch:</h3>
    <div style="white-space: nowrap;">
        <svg id="critterYearPlot" width="500" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
        <svg id="countYearPlot" width="500" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
        <div><span style="padding-left: 125px;">Critter Avg Energy and Repro</span><span style="padding-left: 375px;">Critter Counts</span></div>
    </div>
    <p></p><p></p>

    <!--    <div class="epochStats">THIS EPIC: <span class='summary'></span></div>-->
    <div class="epochStats">
<!--        <span class='statsFile'></span><br>-->
        Avg Wolf Energy: <span class='wolfEn'></span> // Avg Wolf Repro: <span class='wolfRe'></span> //// 
        Avg Rabbit Energy: <span class='rabbitEn'></span> // Avg Rabbit Repro: <span class='rabbitRe'></span>
        <br><br>
        Critter Counts:
        <span class='wolfNum'></span> Wolves // <span class='rabbitNum'></span> Rabbits // 
        <span class='grassNum'></span> Plants
    </div>
    
    <!--    the epochStats plots -->
    <h3>Epoch Stats: </h3>
    <div style="white-space: nowrap;">
        <svg id="critterStatsPlot" width="300" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
        <svg id="countStatsPlot" width="300" height="200" style="border: 1px solid; border-color: #ccc;"></svg>
        <svg id="firstExtStatsPlot" width="300" height="200" style="border: 1px solid; border-color: #ccc;"></svg>

        <div><span style="padding-left: 65px;">Critter Energy and Repro</span><span style="padding-left: 165px;">Critter Starting Counts</span><span style="padding-left: 175px;">First Extinction</span></div>
    </div>
    <p></p><p></p>
    
</body>
</html>